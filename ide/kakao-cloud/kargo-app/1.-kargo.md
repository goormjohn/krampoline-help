# 1. Kargo 배포 구성 파일 작성

## Kargo 배포에 필요한 배포 구성 파일을 작성합니다.

Kargo를 이용한 앱 배포 시 github 소스 저장소의 **main 브랜치**에 저장된 소스 코드에서 **쿠버네티스 리소스 구성 파일**을 읽어옵니다.\
구성파일의 경우 프로젝트 루트 디렉토리의 **k8s 폴더** 하위에 위치해야 합니다.

<figure><img src="../../../.gitbook/assets/image (230).png" alt=""><figcaption><p>Kargo 배포 설정파일 폴더</p></figcaption></figure>

Kargo에서는 **k8s 폴더** 하위의 **kustomization.yaml** 파일을 참고합니다.\
**kustomization.yaml에서는 k8s 폴더에 함께 있는 구성 파일들을 참조하도록 작성할 수 있습니다.**

<figure><img src="../../../.gitbook/assets/image (231).png" alt=""><figcaption><p><strong>kustomization.yaml</strong></p></figcaption></figure>

kustomization.yaml의 작성 예시는 아래와 같습니다.\
k8s 폴더에 함께 있는 구성 파일들(mariadb.yaml, backend.yaml, frontend.yaml)을 참조하고 있습니다.

```yaml
namespace: kakao
resources:
  - mariadb.yaml
  - backend.yaml
  - frontend.yaml
```

각각의 쿠버네티스 구성 파일 작성 시 D2Hub 이미지 경로를 사용해서 작성해야 합니다.\
크램폴린 IDE의 D2hub 탭에서 이미지 경로를 간단하게 복사할 수 있습니다.\
각 레포지토리 우측의 복사 버튼을 클릭해서 이미지 경로를 복사합니다.

<figure><img src="../../../.gitbook/assets/image (233).png" alt=""><figcaption><p>D2Hub 이미지 경로 복사하기</p></figcaption></figure>

해당 버튼을 클릭하면 다음과 같은 형식의 이미지 경로가 복사됩니다.

```sh
krmp-d2hub-idock.9rum.cc/dev-test/repo_d6dce6ccda23
```

이를 이용하여 쿠버네티스 구성 파일을 작성합니다.\
이미지 경로의 경우 보통 구성 파일의 deployment 객체에 작성합니다.\
D2Hub 이미지 경로를 이용한 deployment 객체 작성 예시는 아래와 같습니다.\
(위 구성 예시에서는 frontend.yaml 또는 backend.yaml 파일에 작성합니다.)

```yaml
apiVersion: apps/v1
kind: Deployment
spec:
    template:
        metadata:
            labels:
                app: backend
        spec:
            containers:
                - name: backend
                  image: krmp-d2hub-idock.9rum.cc/dev-test/repo_d6dce6ccda23
                  imagePullPolicy: Always
                  ports:
                      - containerPort: 8080
```

또한 이후에 배포된 앱에 연결된 외부 접속 URL을 발급하기 위해서는 Ingress 객체에 대한 정의가 필요합니다.\
Ingress 객체의 IP에 외부 접속 URL을 연결하기 때문에 반드시 정의해야 합니다.

Ingress 객체의 작성 예시는 다음과 같습니다.

```yaml
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
    name: krampoline
    namespace: default
spec:
    rules:
        - http:
              paths:
                  - backend:
                        serviceName: frontend-service
                        servicePort: 80
                        # 여러분의 app path 를 넣어주세요.
                        path: /kfed0910e2e37a(/|$)(.*)
```

이 때 path 부분에 배포할 Kargo App이 할당 받은 uid를 입력해야 합니다.\
Kargo App이 할당 받은 uid는 각 App 우측의 복사 버튼을 클릭해서 복사할 수 있습니다.

<figure><img src="../../../.gitbook/assets/스크린샷 2023-08-23 오전 11.41.49.png" alt=""><figcaption><p>Kargo App UID 복사하기</p></figcaption></figure>



위 작업 외에도 배포에 필요한 쿠버네티스 설정이 추가로 필요합니다.\
작업을 모두 마쳤다면 github 소스 저장소의 main 브랜치에 push 합니다.\


